---
test_name: Test User Preferences Edge Cases

stages:
  - name: Signup user for preferences test
    request:
      url: "{tavern.env_vars.TEST_FRONTEND_URL}/auth/signup"
      method: POST
      json:
        email: "test{tavern.env_vars.TEST_TIMESTAMP}_prefs@test.com"
        password: "password123"
        display_name: "Prefs User {tavern.env_vars.TEST_TIMESTAMP}"
        age: 35
        gender: "Male"
    response:
      status_code: 201

  - name: Login to get token
    request:
      url: "{tavern.env_vars.TEST_FRONTEND_URL}/auth/login"
      method: POST
      json:
        email: "test{tavern.env_vars.TEST_TIMESTAMP}_prefs@test.com"
        password: "password123"
    response:
      status_code: 200
      save:
        json:
          token: "token"

  - name: Get categories to find valid category ID
    request:
      url: "{tavern.env_vars.TEST_FRONTEND_URL}/users/categories"
      method: GET
      headers:
        Authorization: "Bearer {token}"
        Content-Type: "application/json"
    response:
      status_code: 200
      save:
        json:
          first_category_id: "[0].category_id"
          second_category_id: "[1].category_id"
          third_category_id: "[2].category_id"

  - name: Set preferences with single category
    request:
      url: "{tavern.env_vars.TEST_FRONTEND_URL}/users/preferences"
      method: POST
      headers:
        Authorization: "Bearer {token}"
        Content-Type: "application/json"
      json:
        category_ids: ["{first_category_id}"]
    response:
      status_code: 200
      json:
        user:
          user_id: !anystr
          email: !anystr
          age: !anyint
          gender: !anystr
          signup_date: !anystr
          preferences: !anystr
          user_preferences:
            - category_id: "{first_category_id}"
              name: !anystr
              subcategories: []
          views: []
        token: !anystr

  - name: Update preferences with multiple categories
    request:
      url: "{tavern.env_vars.TEST_FRONTEND_URL}/users/preferences"
      method: POST
      headers:
        Authorization: "Bearer {token}"
        Content-Type: "application/json"
      json:
        category_ids: ["{first_category_id}", "{second_category_id}", "{third_category_id}"]
    response:
      status_code: 200
      json:
        user:
          user_id: !anystr
          email: !anystr
          age: !anyint
          gender: !anystr
          signup_date: !anystr
          preferences: !anystr
          user_preferences:
            - category_id: "{first_category_id}"
              name: !anystr
              subcategories: []
            - category_id: "{second_category_id}"
              name: !anystr
              subcategories: []
            - category_id: "{third_category_id}"
              name: !anystr
              subcategories: []
          views: []
        token: !anystr

  - name: Set empty preferences
    request:
      url: "{tavern.env_vars.TEST_FRONTEND_URL}/users/preferences"
      method: POST
      headers:
        Authorization: "Bearer {token}"
        Content-Type: "application/json"
      json:
        category_ids: []
    response:
      status_code: 200
      json:
        user:
          user_id: !anystr
          email: !anystr
          age: !anyint
          gender: !anystr
          signup_date: !anystr
          preferences: ""
          user_preferences: []
          views: []
        token: !anystr
